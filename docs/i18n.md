# 国际化 (i18n) 配置说明

本项目已配置支持中英文双语切换功能，采用**非路由入侵模式**（Cookie-based）。

## 技术栈

- **next-intl**: Next.js 15+ App Router 推荐的国际化解决方案
- **支持语言**: 
  - 英文 (en) - 默认语言
  - 中文 (zh)
- **模式**: 非路由入侵（Non-intrusive URL mode）- 语言存储在 Cookie 中

## 项目结构

```
learning_nextjs_again/
├── app/
│   ├── layout.tsx          # 根布局（包含 i18n provider）
│   ├── page.tsx            # 首页
│   └── globals.css
├── components/
│   └── LanguageSwitcher.tsx # 语言切换组件
├── i18n/
│   ├── config.ts           # 语言配置
│   ├── request.ts          # Next-intl 请求配置
│   └── routing.ts          # 路由配置（非入侵模式）
├── lib/
│   └── locale.ts           # Cookie-based 语言管理
├── messages/
│   ├── en.json             # 英文翻译
│   └── zh.json             # 中文翻译
└── middleware.ts           # 语言中间件
```

## 使用方法

### 1. 访问应用

- **所有页面使用相同 URL**: `http://localhost:3000/`
- **无语言前缀**: URL 中不显示 `/en` 或 `/zh`
- **语言偏好**: 通过 Cookie 存储，跨会话保持
- **切换语言**: 使用右上角的语言切换器，无需刷新页面

### 2. 在组件中使用翻译

#### Server Component（服务端组件）

```tsx
import { useTranslations } from 'next-intl';

export default function MyComponent() {
  const t = useTranslations('HomePage');
  
  return <h1>{t('title')}</h1>;
}
```

#### Client Component（客户端组件）

```tsx
'use client';

import { useTranslations } from 'next-intl';

export default function MyClientComponent() {
  const t = useTranslations('HomePage');
  
  return <button>{t('buttonText')}</button>;
}
```

### 3. 添加新的翻译

在 `messages/en.json` 和 `messages/zh.json` 中添加对应的键值对：

**messages/en.json**
```json
{
  "HomePage": {
    "title": "Welcome"
  }
}
```

**messages/zh.json**
```json
{
  "HomePage": {
    "title": "欢迎"
  }
}
```

### 4. 使用导航

在非路由入侵模式下，可以直接使用 Next.js 的标准导航：

```tsx
import Link from 'next/link';
import { useRouter } from 'next/navigation';

// 使用标准 Link 组件
<Link href="/about">About</Link>

// 使用标准 useRouter
const router = useRouter();
router.push('/about');
```

语言会自动从 Cookie 中读取，无需在 URL 中指定。

### 5. 语言切换

项目已包含 `LanguageSwitcher` 组件，使用 Server Action 更新 Cookie：

```tsx
import LanguageSwitcher from '@/components/LanguageSwitcher';

export default function Header() {
  return (
    <header>
      <LanguageSwitcher />
    </header>
  );
}
```

组件实现：
```tsx
'use client';

import { setUserLocale } from '@/lib/locale';

const onSelectChange = (newLocale: string) => {
  startTransition(() => {
    setUserLocale(newLocale as Locale); // 更新 Cookie 并刷新页面
  });
};
```

## 配置说明

### 修改默认语言

编辑 `i18n/config.ts`:

```typescript
export const locales = ['en', 'zh'] as const;
export const defaultLocale: Locale = 'zh'; // 改为中文作为默认语言
```

### 添加新语言

1. 在 `messages/` 目录添加新的语言文件，如 `ja.json` (日语)
2. 更新 `i18n/config.ts`:

```typescript
export const locales = ['en', 'zh', 'ja'] as const; // 添加新语言
export type Locale = (typeof locales)[number];
export const defaultLocale: Locale = 'en';
```

3. 更新 `i18n/routing.ts`:

```typescript
export const routing = defineRouting({
  locales: ['en', 'zh', 'ja'], // 添加新语言
  defaultLocale: 'en',
  localePrefix: 'never' // 保持非入侵模式
});
```

4. 在 `LanguageSwitcher.tsx` 中添加选项：

```tsx
<option value="ja">日本語</option>
```

## 最佳实践

1. **翻译文件组织**: 按功能模块组织翻译键，如 `HomePage`、`AboutPage`、`Common` 等
2. **翻译键命名**: 使用有意义的驼峰命名，如 `buttonSubmit` 而不是 `btn1`
3. **默认值**: 始终为所有支持的语言提供翻译，避免缺失键
4. **类型安全**: 考虑使用 TypeScript 为翻译键生成类型定义

## 开发和构建

```bash
# 开发模式
pnpm dev

# 构建生产版本
pnpm build

# 启动生产服务器
pnpm start
```

## 非路由入侵模式的优势

1. **SEO 友好**: URL 保持简洁，无语言前缀
2. **用户体验**: URL 不会在切换语言时改变
3. **简化分享**: 分享的链接对所有用户都一样
4. **兼容性**: 与现有 URL 结构兼容，无需重定向

## 工作原理

### Cookie 存储

语言偏好存储在名为 `NEXT_LOCALE` 的 Cookie 中：

```typescript
// lib/locale.ts
const COOKIE_NAME = 'NEXT_LOCALE';

export async function getUserLocale(): Promise<Locale> {
  const cookieStore = await cookies();
  return (cookieStore.get(COOKIE_NAME)?.value as Locale) || defaultLocale;
}

export async function setUserLocale(locale: Locale) {
  const cookieStore = await cookies();
  cookieStore.set(COOKIE_NAME, locale);
}
```

### Middleware

Middleware 不会修改 URL，只负责确保请求包含正确的 locale 信息：

```typescript
// middleware.ts
export const config = {
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)']
};
```

## 常见问题

### Q: URL 中没有语言标识，如何知道当前语言？

A: 语言存储在 Cookie 中，服务器和客户端都可以访问。使用 `useLocale()` 或 `getLocale()` 获取当前语言。

### Q: 首次访问时如何确定语言？

A: 如果 Cookie 不存在，使用 `defaultLocale`（默认为 'en'）。未来可以根据浏览器的 `Accept-Language` 头自动检测。

### Q: 如何在 metadata 中使用翻译？

A: 在 layout.tsx 或 page.tsx 中导出 `generateMetadata` 函数：

```tsx
import { getTranslations } from 'next-intl/server';

export async function generateMetadata({ params }) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'HomePage' });
  
  return {
    title: t('title'),
    description: t('description')
  };
}
```

### Q: 如何获取当前语言？

A: 使用 `useLocale()` hook：

```tsx
import { useLocale } from 'next-intl';

const locale = useLocale(); // 'en' 或 'zh'
```

